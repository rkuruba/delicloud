<!DOCTYPE html>
<html lang="en">
<head>
    <title>Delicloud - Visualization of cloud orders delivered</title>
    <meta charset="UTF-8">
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="static/css/dc.css"/> -->
    <link type="text/css" rel="stylesheet" href="static/css/dc-floatleft.css"/>
    <style>
      #table td {
        padding-left: 10px;
      }
    </style>
</head>
<body>
 <div class="container text-center">
    <h1 class="jumbotron">DELICLOUD</h1>

    <div style = "margin: 0; overflow: hidden; background-color: #333; font-family: Arial; text-decoration: none; font-size: 16px; padding: 14px 16px">
      <a href="/map">View Map</a>
      <a style = "padding-left: 20px" href="/data">View Data</a> 
    </div>


      <!-- <table class="table"> -->
      <!-- ul style="list-style: none;"-->
      <!-- {% for product in productlist %}
      <tbody>
      <tr>
          <ld>{{ product.AddedToHoststand}}</ld><ld>{{ product.SKU }}</ld><ld>{{ product.VPCRegion}}</ld>
        {% endfor %}
      </tr>
      <!-- </ul> -->
     <!-- </tbody>
    </table>
    </div>
</div> --> 
<div class="container">
  <div id="chart-ring-region" style="width:300px; height:330px">
    <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
      <a href="javascript:regionRingChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div>
  <!-- <div id="chart-hist-spend" style="width:300px; height:330px">
    <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
      <a href="javascript:spendHistChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div> -->
  <center><p>Total $ Spent</p></center>
  <div id="chart-row-spenders" style="width:600px; height:330px; float: left">
    <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
      <a href="javascript:spenderRowChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div>
  <!-- not sure why all these styles necessary, not the point of this -->
  <div style="clear: both; margin: 30px; padding:20px"></div>
    <div id="table"></div>
    <div id="download-type" style="clear: both; float: left">
      <div><label><input type=radio name="operation" value="raw" checked="true">&nbsp;all data</label></div>
      <div><label><input type=radio name="operation" value="table">&nbsp;table data</label></div>
    </div>
    <div style="float: left">
      <button class="btn" id="download">download</button>
    </div>
  </div>

<!--<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript" src="../js/FileSaver.js"></script> -->

<script src=https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/dc/4.0.5/dc.js></script>
<script src="http://cdn.jsdelivr.net/g/filesaver.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script type="text/javascript">

var regionRingChart   = new dc.PieChart("#chart-ring-region"),
   // spendHistChart  = new dc.BarChart("#chart-hist-spend"),
    spenderRowChart = new dc.RowChart("#chart-row-spenders");

var table = new dc.DataTable('#table');
var i = 0;
console.log(i);
var someJavaScriptVarDate = '{{productlist[0].AddedToHS}}';
var someJavaScriptVarRegion = '{{productlist[0].VPCRegion}}';
console.log('{{productlist|length}}')
console.log(someJavaScriptVarDate);
console.log(someJavaScriptVarRegion);
var spendData = []

var now = new Date('{{productlist[0].AddedToHS}}');
var dateString = moment(now).format('MMM');
console.log(dateString);

{% for product in productlist %} 

console.log('{{product}}');

var now = new Date('{{product.AddedToHS}}');
var dateString = moment(now).format('MMM');
console.log(dateString);
var spendDataRecord = {ID: '{{product.ID}}', Month: dateString, Spent: '$'+'{{product.Spent}}', Region: '{{product.VPCRegion}}'}
console.log(spendDataRecord);
spendData.push(spendDataRecord);

{%endfor%}
console.log(spendData);

// normalize/parse data
spendData.forEach(function(d) {
    d.Spent = d.Spent.match(/\d+/)[0];
});

// set crossfilter
var ndx = crossfilter(spendData),
    regionDim  = ndx.dimension(function(d) {return d.Region;}),
    spendDim = ndx.dimension(function(d) {return Math.floor(d.Spent/10);}),
    monthDim  = ndx.dimension(function(d) {return d.Month;}),
    spendPerRegion = regionDim.group().reduceSum(function(d) {return +d.Spent;}),
    spendPerMonth = monthDim.group().reduceSum(function(d) {return +d.Spent;}),
    spendHist    = spendDim.group().reduceCount();

  regionRingChart
    .width(300)
    .height(300)
    .dimension(regionDim)
    .group(spendPerRegion)
    .innerRadius(50)
    .controlsUseVisibility(true);

//   spendHistChart
//     .dimension(spendDim)
//     .group(spendHist)
//     .x(d3.scaleLinear().domain([300,3000]))
//     .elasticY(true)
//     .controlsUseVisibility(true);

// spendHistChart.xAxis().tickFormat(function(d) {return d*3000}); // convert back to base unit
// spendHistChart.yAxis().ticks(2);

spenderRowChart
    .dimension(monthDim)
    .group(spendPerMonth)
    .elasticX(true)
    .controlsUseVisibility(true);

var allDollars = ndx.groupAll().reduceSum(function(d) { return +d.Spent; });

table
    .dimension(spendDim)
    .sortBy(function(d) { return +d.Spent; })
    .showSections(false)
    .columns(['ID',
              'Month',
              '  ',
              {
                  label: 'Spent',
                  format: function(d) {
                      return '$' + d.Spent;
                  }
              },
              'Region',
              {
                  label: 'Percent of Total',
                  format: function(d) {
                      return Math.floor((d.Spent / allDollars.value()) * 100) + '%';
                  }
              }]);

d3.select('#download')
    .on('click', function() {
        var data = monthDim.top(Infinity);
        if(d3.select('#download-type input:checked').node().value==='table') {
            data = data.sort(function(a, b) {
                return table.order()(table.sortBy()(a), table.sortBy()(b));
            });
            data = data.map(function(d) {
                var row = {};
                table.columns().forEach(function(c) {
                    row[table._doColumnHeaderFormat(c)] = table._doColumnValueFormat(c, d);
                });
                return row;
            });
        }
        var blob = new Blob([d3.csvFormat(data)], {type: "text/csv;charset=utf-8"});
        saveAs(blob, 'data.csv');
    });

dc.renderAll();

</script>

</div>
</body>
</html>